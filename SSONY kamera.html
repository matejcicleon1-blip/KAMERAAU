<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KLEO AI Vision Pro - FIXED</title>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; }
        #view { width: 100vw; height: 100vh; object-fit: cover; }
        .ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .top-info { position: absolute; top: 0; width: 100%; background: rgba(0,0,0,0.7); padding: 10px; text-align: center; pointer-events: auto; }
        #status { color: #f1c40f; font-weight: bold; font-size: 16px; }
        .prediction-overlay { position: absolute; bottom: 160px; width: 100%; text-align: center; display: none; }
        .anchor-row { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .a-box { background: #2980b9; padding: 15px; border-radius: 10px; font-size: 24px; font-weight: bold; min-width: 50px; border: 2px solid #fff; }
        .controls { position: absolute; bottom: 0; width: 100%; padding: 20px; background: rgba(0,0,0,0.8); pointer-events: auto; text-align: center; }
        #zoomRange { width: 80%; }
        .btn { padding: 15px 30px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; }
        .btn-start { background: #27ae60; color: #fff; }
        .btn-reset { background: #c0392b; color: #fff; margin-left: 10px; }
        #aimer { position: absolute; width: 40px; height: 100px; border: 2px solid #fff; display: none; transform: translate(-50%, -50%); pointer-events: none; }
    </style>
</head>
<body>

<canvas id="view"></canvas>
<div id="aimer"></div>

<div class="ui">
    <div class="top-info">
        <div id="status">DODIRNI DIJAMANT NA EKRANU</div>
        <div style="font-size: 11px; color: #aaa;">
            R: <span id="valR">--</span>s | B: <span id="valB">--</span>s
        </div>
    </div>

    <div id="result" class="prediction-overlay">
        <div id="sector-list" style="color:#2ecc71; font-weight:bold; margin-bottom:5px;"></div>
        <div class="anchor-row">
            <div class="a-box" id="a1"></div>
            <div class="a-box" id="a2" style="background:#27ae60;"></div>
            <div class="a-box" id="a3"></div>
        </div>
    </div>

    <div class="controls">
        <input type="range" id="zoomRange" min="1" max="10" step="0.1" value="1"><br>
        <button id="startBtn" class="btn btn-start">START</button>
        <button id="resetBtn" class="btn btn-reset">RESET</button>
    </div>
</div>

<video id="video" playsinline muted style="display:none"></video>

<script>
    const BROJEVI = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
    const ALPHA = 0.017, BETA = 0.118, OMEGA_FALL = 10.37, K_FACTOR = 0.006;

    let cameraRunning = false, tTimes = [], bTimes = [], anchorPos = null;
    let prevR = null, prevB = null, lastRT = 0, lastBT = 0;
    
    const canvas = document.getElementById("view"), ctx = canvas.getContext("2d", {willReadFrequently:true});
    const video = document.getElementById("video"), aimer = document.getElementById("aimer");

    window.addEventListener('pointerdown', (e) => {
        if (!cameraRunning || e.target.closest('.controls')) return;
        anchorPos = { x: e.clientX, y: e.clientY };
        aimer.style.display = "block";
        aimer.style.left = e.clientX + "px";
        aimer.style.top = e.clientY + "px";
        resetData();
    });

    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: 1280, height: 720 } });
        video.srcObject = stream; video.play();
        cameraRunning = true;
        document.getElementById("startBtn").style.display = "none";
        requestAnimationFrame(drawLoop);
    }

    function drawLoop() {
        if (!cameraRunning) return;
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        
        const zoom = document.getElementById('zoomRange').value;
        const w = canvas.width / zoom, h = canvas.height / zoom;
        const xOff = (canvas.width - w) / 2, yOff = (canvas.height - h) / 2;
        
        ctx.drawImage(video, xOff, yOff, w, h, 0, 0, canvas.width, canvas.height);

        if (anchorPos) {
            // Crtanje indikatora senzora za provjeru
            ctx.fillStyle = "red"; ctx.fillRect(anchorPos.x-2, anchorPos.y+30, 4, 4); // Rotor senzor
            ctx.fillStyle = "lime"; ctx.fillRect(anchorPos.x-2, anchorPos.y-30, 4, 4); // Ball senzor
            
            const rData = getAvg(ctx.getImageData(anchorPos.x-5, anchorPos.y+25, 10, 10));
            const bData = getAvg(ctx.getImageData(anchorPos.x-5, anchorPos.y-35, 10, 10));

            // Detekcija s povećanom osjetljivošću (15 umjesto 25)
            if (prevR !== null && tTimes.length < 2 && Math.abs(rData - prevR) > 15) {
                const now = performance.now()/1000;
                if (Date.now() - lastRT > 1000) { tTimes.push(now); lastRT = Date.now(); }
            }
            if (prevB !== null && tTimes.length === 2 && bTimes.length < 2 && Math.abs(bData - prevB) > 15) {
                const now = performance.now()/1000;
                if (Date.now() - lastBT > 500) { bTimes.push(now); lastBT = Date.now(); }
            }
            prevR = rData; prevB = bData;
            
            if (tTimes.length === 2) document.getElementById("valR").innerText = (tTimes[1]-tTimes[0]).toFixed(2);
            if (bTimes.length === 2) {
                document.getElementById("valB").innerText = (bTimes[1]-bTimes[0]).toFixed(2);
                calculateResult();
            }
        }
        requestAnimationFrame(drawLoop);
    }

    function calculateResult() {
        if (document.getElementById("result").style.display === "block") return;
        const tR = tTimes[1] - tTimes[0], tB = bTimes[1] - bTimes[0];
        const off = parseFloat(document.getElementById("offset").value) || 12;

        let omega = (2 * Math.PI) / tB;
        let t_fall = (omega - OMEGA_FALL) / ((ALPHA * Math.pow(omega, 2) + BETA) / omega);
        let nu0 = (1 / tR) - (K_FACTOR * tR / 2);
        let centar = Math.round((nu0 * t_fall - (K_FACTOR / 2) * Math.pow(t_fall, 2)) * 37 + off);

        let s = [];
        for(let i = -7; i <= 7; i++) s.push(BROJEVI[((centar + i) % 37 + 37) % 37]);
        
        document.getElementById("a1").innerText = s[2];
        document.getElementById("a2").innerText = s[7];
        document.getElementById("a3").innerText = s[12];
        document.getElementById("sector-list").innerText = s.join(" ");
        document.getElementById("result").style.display = "block";
        document.getElementById("status").innerText = "POGOĐENO!";
    }

    function getAvg(img) {
        let d = img.data, s = 0;
        for(let i=0; i<d.length; i+=4) s += (d[i]+d[i+1]+d[i+2])/3;
        return s / (d.length/4);
    }

    function resetData() {
        tTimes = []; bTimes = []; prevR = null; prevB = null;
        document.getElementById("result").style.display = "none";
        document.getElementById("status").innerText = "PRATIM...";
    }

    document.getElementById("startBtn").onclick = startCamera;
    document.getElementById("resetBtn").onclick = resetData;
</script>
</body>
</html>