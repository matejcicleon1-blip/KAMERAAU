<!DOCTYPE html>
<html lang="hr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KLEO AI - Ultra Ball Detection</title>
    <style>
        body { font-family: sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; width: 100vw; height: 100vh; }
        #view { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .top-info { position: absolute; top: 0; width: 100%; background: rgba(0,0,0,0.6); padding: 5px; text-align: center; pointer-events: auto; }
        #status { color: #f1c40f; font-weight: bold; font-size: 18px; }
        .prediction-overlay { position: absolute; top: 40%; left: 50%; transform: translate(-50%, -50%); width: 100%; text-align: center; display: none; }
        .anchor-row { display: flex; justify-content: center; gap: 8px; margin-top: 10px; }
        .a-box { background: rgba(41, 128, 185, 0.95); padding: 20px; border-radius: 15px; font-size: 32px; font-weight: bold; min-width: 70px; border: 3px solid #fff; }
        #a2 { background: rgba(39, 174, 96, 0.95); scale: 1.1; }
        .controls { position: absolute; bottom: 0; width: 100%; pointer-events: auto; text-align: center; background: rgba(0,0,0,0.7); padding: 15px 0; }
        .slider-label { font-size: 10px; color: #aaa; text-transform: uppercase; display: block; }
        #zoomRange, #gapRange { width: 80%; height: 35px; }
        .btn-row { display: flex; justify-content: center; gap: 10px; margin-top: 10px; }
        .btn { padding: 12px; border: none; border-radius: 8px; font-weight: bold; font-size: 14px; width: 40%; }
        .btn-start { background: #27ae60; color: #fff; }
        .btn-reset { background: #c0392b; color: #fff; }
    </style>
</head>
<body>

<canvas id="view"></canvas>

<div class="ui">
    <div class="top-info">
        <div id="status">DODIRNI DIJAMANT</div>
        <div style="font-size: 10px;">R: <span id="valR">--</span> | B: <span id="valB">--</span> | OFF: <input type="number" id="offset" value="12" style="width:30px; background:none; color:#fff; border:1px solid #777;"></div>
    </div>

    <div id="result" class="prediction-overlay">
        <div id="sector-list" style="color:#2ecc71; font-weight:bold; margin-bottom:15px; background:rgba(0,0,0,0.8); display:inline-block; padding:5px 20px; border-radius:20px;"></div>
        <div class="anchor-row">
            <div class="a-box" id="a1"></div>
            <div class="a-box" id="a2"></div>
            <div class="a-box" id="a3"></div>
        </div>
    </div>

    <div class="controls">
        <span class="slider-label">Zoom</span>
        <input type="range" id="zoomRange" min="1" max="5" step="0.1" value="1.2">
        <span class="slider-label">Razmak Senzora (Gore/Dolje)</span>
        <input type="range" id="gapRange" min="10" max="150" step="1" value="55">
        <div class="btn-row">
            <button id="startBtn" class="btn btn-start">START</button>
            <button id="resetBtn" class="btn btn-reset">RESET</button>
        </div>
    </div>
</div>

<video id="video" playsinline muted style="display:none"></video>

<script>
    const BROJEVI = [0, 32, 15, 19, 4, 21, 2, 25, 17, 34, 6, 27, 13, 36, 11, 30, 8, 23, 10, 5, 24, 16, 33, 1, 20, 14, 31, 9, 22, 18, 29, 7, 28, 12, 35, 3, 26];
    const ALPHA = 0.017, BETA = 0.118, OMEGA_FALL = 10.37, K_FACTOR = 0.006;

    let cameraRunning = false, tTimes = [], bTimes = [], anchorPos = null;
    let lastRT = 0, lastBT = 0;
    
    const canvas = document.getElementById("view"), ctx = canvas.getContext("2d", { alpha: false });
    const video = document.getElementById("video");

    window.addEventListener('pointerdown', (e) => {
        if (!cameraRunning || e.target.closest('.controls') || e.target.closest('.top-info')) return;
        anchorPos = { x: e.clientX, y: e.clientY };
        resetData();
    });

    async function startCamera() {
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: "environment", width: {ideal: 1280}, height: {ideal: 720}, frameRate: {ideal: 60} } 
        });
        video.srcObject = stream; video.play();
        cameraRunning = true;
        document.getElementById("startBtn").style.display = "none";
        requestAnimationFrame(drawLoop);
    }

    function isGreen(r, g, b) {
        return (g > r * 1.2 && g > b * 1.2 && g > 40);
    }

    // NOVA FUNKCIJA: Traži najsvjetliji piksel (detekcija bijele loptice)
    function getMaxBrightness(imgData) {
        let maxB = 0;
        const d = imgData.data;
        for (let i = 0; i < d.length; i += 4) {
            let brightness = (d[i] + d[i+1] + d[i+2]) / 3;
            if (brightness > maxB) maxB = brightness;
        }
        return maxB;
    }

    let prevMaxB = 0;

    function drawLoop() {
        if (!cameraRunning) return;
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const zoom = parseFloat(document.getElementById('zoomRange').value);
        const gap = parseInt(document.getElementById('gapRange').value);

        const w = canvas.width / zoom, h = canvas.height / zoom;
        const xOff = (canvas.width - w) / 2, yOff = (canvas.height - h) / 2;
        ctx.drawImage(video, xOff, yOff, w, h, 0, 0, canvas.width, canvas.height);

        if (anchorPos) {
            const rotorY = anchorPos.y + gap;
            const ballY = anchorPos.y - gap;

            ctx.lineWidth = 2;
            ctx.strokeStyle = "red"; ctx.strokeRect(anchorPos.x - 20, rotorY - 20, 40, 40); 
            ctx.strokeStyle = "lime"; ctx.strokeRect(anchorPos.x - 20, ballY - 20, 40, 40); 

            const rData = ctx.getImageData(anchorPos.x - 15, rotorY - 15, 30, 30).data;
            const bData = ctx.getImageData(anchorPos.x - 15, ballY - 15, 30, 30);
            
            const now = performance.now() / 1000;

            // 1. Detekcija Nule (Rotor)
            if (tTimes.length < 2) {
                let greenFound = false;
                for (let i = 0; i < rData.length; i += 4) {
                    if (isGreen(rData[i], rData[i+1], rData[i+2])) { greenFound = true; break; }
                }
                if (greenFound && (Date.now() - lastRT > 1800)) {
                    tTimes.push(now); lastRT = Date.now();
                    document.getElementById("status").innerText = `NULA: ${tTimes.length}/2`;
                }
            }

            // 2. Poboljšana Detekcija Loptice (Max Brightness)
            const currentMaxB = getMaxBrightness(bData);
            if (tTimes.length === 2 && bTimes.length < 2) {
                // Ako najsvjetliji piksel naglo postane puno svjetliji (loptica ušla)
                // Ili ako pređe fiksni prag od 180 (bijela boja)
                if ((currentMaxB - prevMaxB > 25 || currentMaxB > 200) && (Date.now() - lastBT > 500)) {
                    bTimes.push(now); lastBT = Date.now();
                    document.getElementById("status").innerText = `LOPTICA: ${bTimes.length}/2`;
                    
                    if (bTimes.length === 2) {
                        let tB = bTimes[1] - bTimes[0];
                        if ((2 * Math.PI) / tB <= OMEGA_FALL) {
                            bTimes = [bTimes[1]];
                            document.getElementById("status").innerText = "BALL SLOW - WAITING...";
                        } else {
                            calculateResult();
                        }
                    }
                }
            }
            prevMaxB = currentMaxB;
            if (tTimes.length === 2) document.getElementById("valR").innerText = (tTimes[1]-tTimes[0]).toFixed(2) + "s";
        }
        requestAnimationFrame(drawLoop);
    }

    function calculateResult() {
        const tR = tTimes[1] - tTimes[0];
        const tB = bTimes[1] - bTimes[0];
        const off = parseFloat(document.getElementById("offset").value);
        let omega = (2 * Math.PI) / tB;
        let t_fall = (omega - OMEGA_FALL) / ((ALPHA * Math.pow(omega, 2) + BETA) / omega);
        let nu0 = (1 / tR) - (K_FACTOR * tR / 2);
        let predjeni_put = (nu0 * t_fall - (K_FACTOR / 2) * Math.pow(t_fall, 2)) * 37;
        let centar = Math.round((predjeni_put + off) % 37 + 37) % 37;

        let s = [];
        for(let i = -7; i <= 7; i++) {
            let idx = (BROJEVI.indexOf(centar) + i + 37) % 37;
            s.push(BROJEVI[idx]);
        }
        document.getElementById("a1").innerText = s[2];
        document.getElementById("a2").innerText = s[7];
        document.getElementById("a3").innerText = s[12];
        document.getElementById("sector-list").innerText = s.join(" - ");
        document.getElementById("result").style.display = "block";
        document.getElementById("status").innerText = "SIDRA SPREMNA!";
    }

    function resetData() {
        tTimes = []; bTimes = []; prevMaxB = 0;
        document.getElementById("result").style.display = "none";
        document.getElementById("status").innerText = "PRATIM...";
    }

    document.getElementById("startBtn").onclick = startCamera;
    document.getElementById("resetBtn").onclick = resetData;
</script>
</body>
</html>
